<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>KLARUS â€” TK22 TrackMan Analyzer v2</title>

  <style>
    /* -----------------------------
       GLOBAL STYLE (DARK/LIGHT)
    ------------------------------*/
    :root {
      --bg: #ffffff;
      --text: #111111;
      --card: #f5f5f5;
      --border: #dddddd;
      --primary: #0057ff;
      --danger: #ff4444;
    }

    body.dark {
      --bg: #111111;
      --text: #eeeeee;
      --card: #1e1e1e;
      --border: #333333;
      --primary: #4c8dff;
      --danger: #ff5555;
    }

    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 15px;
      opacity: 0.7;
      margin-bottom: 20px;
    }

    /* Dark toggle */
    .dark-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--card);
      padding: 8px 14px;
      border-radius: 10px;
      cursor: pointer;
      border: 1px solid var(--border);
    }

    /* -----------------------------
       STEP BLOCKS
    ------------------------------*/
    .step {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 18px;
      border-radius: 14px;
      margin-bottom: 24px;
    }

    .step h2 {
      margin-top: 0;
      font-size: 20px;
    }

    .step .desc {
      font-size: 14px;
      opacity: 0.7;
      margin-bottom: 14px;
    }

    label {
      display: block;
      margin-top: 12px;
      margin-bottom: 4px;
      font-weight: 600;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
    }

    .step-complete {
      color: var(--primary);
      font-size: 14px;
      margin-top: 6px;
      font-weight: 600;
    }

    .error {
      color: var(--danger);
      font-size: 13px;
      margin-top: 4px;
    }

    /* Buttons */
    button {
      background: var(--primary);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      margin-top: 18px;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
    }

    .two-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

  </style>
</head>

<body>

<div class="dark-toggle" onclick="toggleDarkMode()">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</div>

<div class="container">
  <h1>KLARUS â€” TK22 TrackMan Analyzer (v2)</h1>
  <div class="subtitle">Kardia Practice Module â€” APP50 & LNG50 ìë™ ë¶„ì„ ì‹œìŠ¤í…œ</div>

  <!-- STEP SYSTEM -->
  <div id="step1" class="step">
    <h2>STEP 1 â€” ëª¨ë“œ ì„ íƒ</h2>
    <div class="desc">ë¶„ì„í•˜ë ¤ëŠ” ì—°ìŠµ ì¢…ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>

    <div class="two-grid">
      <button type="button" onclick="selectMode('APP50')">APP50 (ì–´í”„ë¡œì¹˜)</button>
      <button type="button" onclick="selectMode('LNG50')">LNG50 (ë¡±ê²Œì„)</button>
    </div>

    <div id="step1-status" class="step-complete" style="display:none;">âœ” ì„ íƒ ì™„ë£Œ</div>
  </div>

  <div id="step2" class="step">
    <h2>STEP 2 â€” TrackMan íŒŒì¼ ì—…ë¡œë“œ</h2>
    <div class="desc">TrackManì—ì„œ Exportí•œ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</div>

    <label>TrackMan CSV íŒŒì¼</label>
    <input type="file" id="fileInput" accept=".csv" onchange="handleFileUpload()">

    <div id="step2-status" class="step-complete" style="display:none;">âœ” íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ</div>
    <div id="file-error" class="error"></div>
  </div>

  <!-- ì—¬ê¸°ë¶€í„° PART 2 ì¶”ê°€ -->

  <style>
    .field-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    .section-title {
      font-weight: 700;
      margin-top: 8px;
      margin-bottom: 4px;
      font-size: 15px;
    }
    .small-note {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 4px;
    }
    .btn-secondary {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
      width: 100%;
    }
    .mode-active {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    .result-title {
      font-weight: 700;
      margin-bottom: 8px;
      font-size: 16px;
    }
    #scatterCanvas {
      width: 100%;
      max-width: 900px;
      height: 260px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg);
    }
    pre {
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.4;
    }
  </style>

  <!-- STEP 3: ë‹¨ìœ„ / ìƒ˜í”Œë§ / í•„ë“œ ë§¤í•‘ -->
  <div id="step3" class="step">
    <h2>STEP 3 â€” ë‹¨ìœ„, ìƒ˜í”Œë§, í•„ë“œ ë§¤í•‘</h2>
    <div class="desc">
      TrackMan CSV í—¤ë”ë¥¼ ì½ì–´ <b>Carry / Total / Offline</b> í•„ë“œë¥¼ ë§¤í•‘í•©ë‹ˆë‹¤.<br />
      í•„ìˆ˜ í•„ë“œ: <b>Carry, Offline</b>
    </div>

    <div class="field-grid">
      <div>
        <label>ë‹¨ìœ„ (Unit)</label>
        <select id="unitSelect" onchange="handleUnitChange()">
          <option value="m">ë¯¸í„° (m)</option>
          <option value="yd">ì•¼ë“œ (yd)</option>
        </select>
      </div>
      <div>
        <label>ìƒ˜í”Œë§ ì˜µì…˜</label>
        <select id="samplingSelect" onchange="handleSamplingChange()">
          <option value="latest50">ìµœì‹  50ìƒ·</option>
          <option value="first50">ìµœì´ˆ 50ìƒ·</option>
          <option value="random50">ë¬´ì‘ìœ„ 50ìƒ·</option>
          <option value="all">ì „ì²´ ì‚¬ìš©</option>
        </select>
      </div>
    </div>

    <div class="section-title" style="margin-top:16px;">í•„ë“œ ë§¤í•‘ (CSV í—¤ë” â†” ë¶„ì„ í•„ë“œ)</div>
    <div class="field-grid">
      <div>
        <label>Carry í•„ë“œ</label>
        <select id="carryField" onchange="handleMappingChange('carry')">
          <option value="">(CSV ì—…ë¡œë“œ í›„ ì„ íƒ)</option>
        </select>
        <div class="small-note">ì˜ˆ: Carry, CarryDistance</div>
      </div>
      <div>
        <label>Total í•„ë“œ (ì„ íƒ)</label>
        <select id="totalField" onchange="handleMappingChange('total')">
          <option value="">(ì„ íƒ ì‚¬í•­)</option>
        </select>
        <div class="small-note">ì˜ˆ: TotalDistance</div>
      </div>
    </div>

    <div class="field-grid">
      <div>
        <label>Offline / Side í•„ë“œ</label>
        <select id="offlineField" onchange="handleMappingChange('offline')">
          <option value="">(CSV ì—…ë¡œë“œ í›„ ì„ íƒ)</option>
        </select>
        <div class="small-note">ì˜ˆ: Offline, Side (ì¢Œ/ìš° +/âˆ’ ë°©í–¥)</div>
      </div>
      <div>
        <label>í—¤ë” ë¯¸ë¦¬ë³´ê¸°</label>
        <div id="headerPreview" class="small-note">CSV ì—…ë¡œë“œ ì‹œ í—¤ë”ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </div>

    <div id="step3-status" class="step-complete" style="display:none;">âœ” í•„ìˆ˜ í•„ë“œ ë§¤í•‘ ì™„ë£Œ</div>
    <div id="mapping-error" class="error"></div>
  </div>

  <!-- STEP 4: APP50 / LNG50 íŒŒë¼ë¯¸í„° -->
  <div id="step4" class="step">
    <h2>STEP 4 â€” ëª¨ë“œë³„ íŒŒë¼ë¯¸í„° ì„¤ì •</h2>
    <div class="desc">
      ì„ íƒí•œ ëª¨ë“œì— ë”°ë¼ í•„ìš”í•œ íŒŒë¼ë¯¸í„°ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.<br />
      ì‚¬ìš©ì´ ì–´ë µë‹¤ë©´ ê¸°ë³¸ê°’ ê·¸ëŒ€ë¡œ ë‘ê³  ì‹¤í–‰í•´ë„ ë©ë‹ˆë‹¤.
    </div>

    <!-- APP50 ì„¤ì • -->
    <div id="app50-settings" style="display:none; margin-bottom:18px;">
      <div class="section-title">APP50 ì„¤ì • (ì–´í”„ë¡œì¹˜)</div>
      <div class="field-grid">
        <div>
          <label>íƒ€ê¹ƒ ê±°ë¦¬ (0ì´ë©´ ìºë¦¬ ì¤‘ì•™ê°’ ìë™)</label>
          <input type="number" id="appTargetDist" value="140" step="0.1">
          <div class="small-note">
            ì˜ˆ: 7ë²ˆ ì•„ì´ì–¸ í‰ê·  ìºë¦¬ê°€ 140më¼ë©´ 140 ì…ë ¥. 0ì´ë©´ ë°ì´í„° ì¤‘ì•™ê°’ ì‚¬ìš©.
          </div>
        </div>
        <div>
          <label>ì»¤ë²„ìœ¨ p (%)</label>
          <input type="number" id="appP" value="80" min="50" max="99" step="1">
          <div class="small-note">
            ì˜ˆ: 80 â†’ ì „ì²´ ìƒ· ì¤‘ 80%ë¥¼ ë®ëŠ” ë¶„ì‚° ë²”ìœ„.
          </div>
        </div>
      </div>
    </div>

    <!-- LNG50 ì„¤ì • -->
    <div id="lng50-settings" style="display:none;">
      <div class="section-title">LNG50 ì„¤ì • (ë¡±ê²Œì„)</div>
      <div class="field-grid">
        <div>
          <label>ì»¤ë²„ìœ¨ p (%)</label>
          <input type="number" id="lngP" value="80" min="50" max="99" step="1">
        </div>
        <div>
          <label>ì¢Œì¸¡ ê²½ê³„ (m / yd)</label>
          <input type="number" id="lngLeft" value="-25" step="0.1">
          <div class="small-note">ì˜ˆ: í˜ì–´ì›¨ì´ í­ 50m, ì¤‘ì•™ ê¸°ì¤€ ì¢Œì¸¡ ë = -25</div>
        </div>
      </div>
      <div class="field-grid">
        <div>
          <label>ìš°ì¸¡ ê²½ê³„ (m / yd)</label>
          <input type="number" id="lngRight" value="25" step="0.1">
          <div class="small-note">ì˜ˆ: ì¤‘ì•™ ê¸°ì¤€ ìš°ì¸¡ ë = +25</div>
        </div>
        <div>
          <label>wL / wR (ì¢Œ/ìš° ë¯¸ìŠ¤ ê°€ì¤‘ì¹˜)</label>
          <div class="field-grid">
            <input type="number" id="lngWL" value="2.0" step="0.1">
            <input type="number" id="lngWR" value="1.0" step="0.1">
          </div>
          <div class="small-note">ì˜ˆ: ì¢Œì¸¡ í•´ì €ë“œ â†’ wL 2.0, ìš°ì¸¡ ëŸ¬í”„ â†’ wR 1.0</div>
        </div>
      </div>
    </div>

    <div id="step4-status" class="step-complete" style="display:none;">âœ” íŒŒë¼ë¯¸í„° ì„¤ì • ì™„ë£Œ</div>
    <div id="param-error" class="error"></div>
  </div>

  <!-- STEP 5: ë¶„ì„ ì‹¤í–‰ -->
  <div id="step5" class="step">
    <h2>STEP 5 â€” ë¶„ì„ ì‹¤í–‰ & ê²°ê³¼</h2>
    <div class="desc">
      ëª¨ë“  ì„¤ì •ì„ í™•ì¸í•œ ë’¤ <b>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¶„ì„ì„ ì‹¤í–‰</b>í•©ë‹ˆë‹¤.
    </div>

    <button type="button" onclick="runAnalysis()">ë¶„ì„ ì‹¤í–‰</button>
    <div id="global-error" class="error" style="margin-top:10px;"></div>
  </div>

  <!-- ê²°ê³¼ ì„¹ì…˜ -->
  <div id="result-section" class="step">
    <h2>ë¶„ì„ ê²°ê³¼</h2>
    <div class="desc">
      APP50: íƒ€ê¹ƒ ëŒ€ë¹„ ê±°ë¦¬Â·ë¶„ì‚° / LNG50: ì¢Œìš° ë¶„í¬Â·ê°€ì¤‘ í˜ë„í‹° ë“±ì„ ìš”ì•½í•©ë‹ˆë‹¤.
    </div>

    <div class="result-title">ìš”ì•½</div>
    <div id="result-summary" class="small-note">ì•„ì§ ë¶„ì„ì´ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>

    <div class="result-title" style="margin-top:16px;">ìƒ· ë¶„í¬ (Carry vs Offline)</div>
    <canvas id="scatterCanvas" width="900" height="260"></canvas>

    <div class="result-title" style="margin-top:16px;">ì„¸ë¶€ ë¦¬í¬íŠ¸</div>
    <pre id="result-details"></pre>
  </div>

</div> <!-- /.container -->

<script>
  // -----------------------------
  // GLOBAL STATE
  // -----------------------------
  const state = {
    mode: null,
    csvText: '',
    csvHeaders: [],
    rows: [],
    mapped: {
      carry: '',
      total: '',
      offline: ''
    },
    unit: 'm',
    sampling: 'latest50'
  };

  // -----------------------------
  // DARK MODE
  // -----------------------------
  function toggleDarkMode() {
    document.body.classList.toggle('dark');
    const btn = document.querySelector('.dark-toggle');
    if (document.body.classList.contains('dark')) {
      btn.textContent = 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ';
    } else {
      btn.textContent = 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ';
    }
  }

  // -----------------------------
  // STEP 1: ëª¨ë“œ ì„ íƒ
  // -----------------------------
  function selectMode(mode) {
    state.mode = mode;

    const buttons = document.querySelectorAll('#step1 button');
    buttons.forEach(btn => btn.classList.remove('mode-active'));

    if (mode === 'APP50') {
      buttons[0].classList.add('mode-active');
      document.getElementById('app50-settings').style.display = 'block';
      document.getElementById('lng50-settings').style.display = 'none';
    } else {
      buttons[1].classList.add('mode-active');
      document.getElementById('app50-settings').style.display = 'none';
      document.getElementById('lng50-settings').style.display = 'block';
    }

    document.getElementById('step1-status').style.display = 'block';
    document.getElementById('global-error').textContent = '';
  }

  // -----------------------------
  // STEP 2: íŒŒì¼ ì—…ë¡œë“œ
  // -----------------------------
  function handleFileUpload() {
    const input = document.getElementById('fileInput');
    const file = input.files[0];
    const fileError = document.getElementById('file-error');
    fileError.textContent = '';

    if (!file) {
      fileError.textContent = 'CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      state.csvText = e.target.result;
      parseCSVHeaders();
      document.getElementById('step2-status').style.display = 'block';
      document.getElementById('global-error').textContent = '';
    };
    reader.onerror = () => {
      fileError.textContent = 'íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    };
    reader.readAsText(file);
  }

  function parseCSVHeaders() {
    const text = state.csvText;
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
    if (lines.length === 0) return;

    const headerLine = lines[0];
    const headers = headerLine.split(',').map(h => h.trim());
    state.csvHeaders = headers;

    document.getElementById('headerPreview').textContent = headers.join(' | ');

    // ì˜µì…˜ ì´ˆê¸°í™”
    const carrySel = document.getElementById('carryField');
    const totalSel = document.getElementById('totalField');
    const offlineSel = document.getElementById('offlineField');

    [carrySel, totalSel, offlineSel].forEach(sel => {
      sel.innerHTML = '<option value="">(ì„ íƒ)</option>';
      headers.forEach(h => {
        const opt = document.createElement('option');
        opt.value = h;
        opt.textContent = h;
        sel.appendChild(opt);
      });
    });

    // ìë™ ë§¤í•‘ ì‹œë„
    autoMapFields(headers);

    // ë°ì´í„° íŒŒì‹±
    parseRows(lines);
    validateMapping();
  }

  function parseRows(lines) {
    const headers = state.csvHeaders;
    const dataLines = lines.slice(1); // í—¤ë” ì œì™¸

    const rows = [];
    dataLines.forEach(line => {
      if (!line.trim()) return;
      const cells = line.split(',');
      const rowObj = {};
      headers.forEach((h, idx) => {
        rowObj[h] = (cells[idx] !== undefined) ? cells[idx].trim() : '';
      });
      rows.push(rowObj);
    });

    state.rows = rows;
  }

  function autoMapFields(headers) {
    const lower = headers.map(h => h.toLowerCase());

    // Carry
    let carryIndex = lower.findIndex(h => h.includes('carry'));
    if (carryIndex === -1) carryIndex = lower.findIndex(h => h.includes('carr'));
    if (carryIndex !== -1) {
      state.mapped.carry = headers[carryIndex];
      document.getElementById('carryField').value = headers[carryIndex];
    }

    // Total
    let totalIndex = lower.findIndex(h => h.includes('total') || h.includes('totdist'));
    if (totalIndex !== -1) {
      state.mapped.total = headers[totalIndex];
      document.getElementById('totalField').value = headers[totalIndex];
    }

    // Offline / Side
    let offlineIndex = lower.findIndex(h => h.includes('offline') || h.includes('side'));
    if (offlineIndex !== -1) {
      state.mapped.offline = headers[offlineIndex];
      document.getElementById('offlineField').value = headers[offlineIndex];
    }
  }

  // -----------------------------
  // STEP 3: ë‹¨ìœ„ / ìƒ˜í”Œë§ / ë§¤í•‘
  // -----------------------------
  function handleUnitChange() {
    const sel = document.getElementById('unitSelect');
    state.unit = sel.value;
  }

  function handleSamplingChange() {
    const sel = document.getElementById('samplingSelect');
    state.sampling = sel.value;
  }

  function handleMappingChange(field) {
    const mappingError = document.getElementById('mapping-error');
    mappingError.textContent = '';

    if (field === 'carry') {
      state.mapped.carry = document.getElementById('carryField').value;
    } else if (field === 'total') {
      state.mapped.total = document.getElementById('totalField').value;
    } else if (field === 'offline') {
      state.mapped.offline = document.getElementById('offlineField').value;
    }
    validateMapping();
  }

  function validateMapping() {
    const mappingError = document.getElementById('mapping-error');
    const requiredMissing = [];

    if (!state.mapped.carry) requiredMissing.push('Carry');
    if (!state.mapped.offline) requiredMissing.push('Offline');

    if (requiredMissing.length > 0) {
      mappingError.textContent = 'í•„ìˆ˜ í•„ë“œ ëˆ„ë½: ' + requiredMissing.join(', ');
      document.getElementById('step3-status').style.display = 'none';
      return false;
    } else {
      mappingError.textContent = '';
      document.getElementById('step3-status').style.display = 'block';
      return true;
    }
  }

  // -----------------------------
  // STEP 4: íŒŒë¼ë¯¸í„° ê²€ì¦ (ê°„ë‹¨)
  // -----------------------------
  function validateParams() {
    const paramError = document.getElementById('param-error');
    paramError.textContent = '';

    if (state.mode === 'APP50') {
      const p = Number(document.getElementById('appP').value || '0');
      if (p <= 0 || p >= 100) {
        paramError.textContent = 'APP50 ì»¤ë²„ìœ¨ pëŠ” 50~99 ì‚¬ì´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.';
        document.getElementById('step4-status').style.display = 'none';
        return false;
      }
    } else if (state.mode === 'LNG50') {
      const p = Number(document.getElementById('lngP').value || '0');
      if (p <= 0 || p >= 100) {
        paramError.textContent = 'LNG50 ì»¤ë²„ìœ¨ pëŠ” 50~99 ì‚¬ì´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.';
        document.getElementById('step4-status').style.display = 'none';
        return false;
      }
    }

    document.getElementById('step4-status').style.display = 'block';
    return true;
  }

  // -----------------------------
  // STEP 5: ë¶„ì„ ì‹¤í–‰
  // -----------------------------
  function runAnalysis() {
    const globalError = document.getElementById('global-error');
    globalError.textContent = '';

    if (!state.mode) {
      globalError.textContent = 'STEP 1ì—ì„œ APP50 ë˜ëŠ” LNG50 ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
      return;
    }
    if (!state.csvText || state.rows.length === 0) {
      globalError.textContent = 'STEP 2ì—ì„œ TrackMan CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';
      return;
    }
    if (!validateMapping()) {
      globalError.textContent = 'STEP 3ì—ì„œ í•„ìˆ˜ í•„ë“œë¥¼ ë§¤í•‘í•´ì£¼ì„¸ìš”.';
      return;
    }
    if (!validateParams()) {
      globalError.textContent = 'STEP 4 íŒŒë¼ë¯¸í„° ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
      return;
    }

    const sampled = getSampledRows();
    if (sampled.length === 0) {
      globalError.textContent = 'ìœ íš¨í•œ ìƒ· ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
      return;
    }

    let summaryText = '';
    let detailText = '';

    if (state.mode === 'APP50') {
      ({ summaryText, detailText } = analyzeAPP50(sampled));
    } else {
      ({ summaryText, detailText } = analyzeLNG50(sampled));
    }

    document.getElementById('result-summary').textContent = summaryText;
    document.getElementById('result-details').textContent = detailText;

    drawScatter(sampled);

    globalError.textContent = '';
  }

  // ìƒ˜í”Œë§ ì ìš©
  function getSampledRows() {
    const rows = state.rows;
    const n = rows.length;
    if (n === 0) return [];

    let indices = Array.from({ length: n }, (_, i) => i);

    if (state.sampling === 'latest50') {
      indices = indices.slice(-50);
    } else if (state.sampling === 'first50') {
      indices = indices.slice(0, 50);
    } else if (state.sampling === 'random50') {
      if (n > 50) {
        // ê°„ë‹¨ ì…”í”Œ
        for (let i = n - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [indices[i], indices[j]] = [indices[j], indices[i]];
        }
        indices = indices.slice(0, 50);
      }
    } else {
      // all
    }

    const carryField = state.mapped.carry;
    const offlineField = state.mapped.offline;
    const totalField = state.mapped.total || null;

    const result = [];
    indices.forEach(idx => {
      const r = rows[idx];
      const carry = parseFloat(r[carryField]);
      const offline = parseFloat(r[offlineField]);
      const total = totalField ? parseFloat(r[totalField]) : NaN;
      if (!isNaN(carry) && !isNaN(offline)) {
        result.push({ carry, offline, total });
      }
    });

    return result;
  }

  // -----------------------------
  // APP50 ë¶„ì„
  // -----------------------------
  function analyzeAPP50(samples) {
    const targetInput = Number(document.getElementById('appTargetDist').value || '0');
    const p = Number(document.getElementById('appP').value || '80');

    const carries = samples.map(s => s.carry);
    const offlines = samples.map(s => s.offline);

    const meanCarry = mean(carries);
    const sdCarry = stdDev(carries, meanCarry);

    let target = targetInput;
    if (!target || target === 0) {
      target = meanCarry;
    }

    const deltas = carries.map(c => c - target);
    const meanDelta = mean(deltas);
    const sdDelta = stdDev(deltas, meanDelta);

    const shortCount = deltas.filter(d => d < 0).length;
    const longCount = deltas.filter(d => d > 0).length;
    const n = samples.length;
    const shortPct = (shortCount / n) * 100;
    const longPct = (longCount / n) * 100;

    const meanOffline = mean(offlines);
    const sdOffline = stdDev(offlines, meanOffline);

    const summaryText =
      `APP50 â€” íƒ€ê¹ƒ ${target.toFixed(1)}${state.unit}, ` +
      `í‰ê·  ìºë¦¬ ${meanCarry.toFixed(1)}${state.unit}, ` +
      `ê±°ë¦¬ ì˜¤ì°¨ í‰ê·  ${meanDelta.toFixed(1)}${state.unit}, ` +
      `ì¢Œìš° ì˜¤í”„ì…‹ í‰ê·  ${meanOffline.toFixed(1)}${state.unit}`;

    let detail = '';
    detail += `â—† ìƒ· ê°œìˆ˜: ${n}\n`;
    detail += `â—† íƒ€ê¹ƒ ê±°ë¦¬: ${target.toFixed(1)} ${state.unit}\n`;
    detail += `â—† í‰ê·  ìºë¦¬: ${meanCarry.toFixed(1)} ${state.unit}\n`;
    detail += `â—† ìºë¦¬ í‘œì¤€í¸ì°¨: ${sdCarry.toFixed(1)} ${state.unit}\n\n`;
    detail += `â—† ê±°ë¦¬ ì˜¤ì°¨(ìºë¦¬ - íƒ€ê¹ƒ)\n`;
    detail += `   - í‰ê· : ${meanDelta.toFixed(1)} ${state.unit}\n`;
    detail += `   - í‘œì¤€í¸ì°¨: ${sdDelta.toFixed(1)} ${state.unit}\n`;
    detail += `   - Short ë¹„ìœ¨: ${shortPct.toFixed(1)}%\n`;
    detail += `   - Long ë¹„ìœ¨: ${longPct.toFixed(1)}%\n\n`;
    detail += `â—† ì¢Œ/ìš° ë¶„í¬ (Offline)\n`;
    detail += `   - í‰ê· : ${meanOffline.toFixed(1)} ${state.unit}\n`;
    detail += `   - í‘œì¤€í¸ì°¨: ${sdOffline.toFixed(1)} ${state.unit}\n\n`;
    detail += `â€» p=${p}% ì»¤ë²„ íƒ€ì›ì€ í˜„ì¬ ì‹œê°í™” ëŒ€ì‹  í…ìŠ¤íŠ¸ í†µê³„ë¡œ ì œê³µ ì¤‘ì…ë‹ˆë‹¤. í•„ìš” ì‹œ Ïƒ íƒ€ì› ì‹œê°í™” ë¡œì§ì„ ì¶”ê°€ë¡œ ë¶™ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n`;

    return { summaryText, detailText: detail };
  }

  // -----------------------------
  // LNG50 ë¶„ì„
  // -----------------------------
  function analyzeLNG50(samples) {
    const p = Number(document.getElementById('lngP').value || '80');
    const left = Number(document.getElementById('lngLeft').value || '-25');
    const right = Number(document.getElementById('lngRight').value || '25');
    const wL = Number(document.getElementById('lngWL').value || '2');
    const wR = Number(document.getElementById('lngWR').value || '1');

    const offlines = samples.map(s => s.offline);
    const carries = samples.map(s => s.carry);

    const meanCarry = mean(carries);
    const sdCarry = stdDev(carries, meanCarry);

    const meanOffline = mean(offlines);
    const sdOffline = stdDev(offlines, meanOffline);

    const n = samples.length;
    let inside = 0, leftMiss = 0, rightMiss = 0;

    offlines.forEach(v => {
      if (v < left) leftMiss++;
      else if (v > right) rightMiss++;
      else inside++;
    });

    const insidePct = (inside / n) * 100;
    const leftPct = (leftMiss / n) * 100;
    const rightPct = (rightMiss / n) * 100;

    const weightedPenalty = leftMiss * wL + rightMiss * wR;

    const summaryText =
      `LNG50 â€” í‰ê·  ìºë¦¬ ${meanCarry.toFixed(1)}${state.unit}, ` +
      `í˜ì–´ì›¨ì´ ì•ˆ(ê²½ê³„ ë‚´) ${insidePct.toFixed(1)}%, ` +
      `ê°€ì¤‘ í˜ë„í‹° ì ìˆ˜ ${weightedPenalty.toFixed(1)}`;

    let detail = '';
    detail += `â—† ìƒ· ê°œìˆ˜: ${n}\n`;
    detail += `â—† í‰ê·  ìºë¦¬: ${meanCarry.toFixed(1)} ${state.unit}\n`;
    detail += `â—† ìºë¦¬ í‘œì¤€í¸ì°¨: ${sdCarry.toFixed(1)} ${state.unit}\n\n`;
    detail += `â—† ì¢Œ/ìš° ë¶„í¬ (Offline)\n`;
    detail += `   - í‰ê· : ${meanOffline.toFixed(1)} ${state.unit}\n`;
    detail += `   - í‘œì¤€í¸ì°¨: ${sdOffline.toFixed(1)} ${state.unit}\n\n`;
    detail += `â—† ê²½ê³„ ê¸°ì¤€ ë¶„í¬\n`;
    detail += `   - í˜ì–´ì›¨ì´ ì•ˆ (Between ${left} ~ ${right}): ${inside}ìƒ· (${insidePct.toFixed(1)}%)\n`;
    detail += `   - ì¢Œì¸¡ ë¯¸ìŠ¤ (< ${left}): ${leftMiss}ìƒ· (${leftPct.toFixed(1)}%)\n`;
    detail += `   - ìš°ì¸¡ ë¯¸ìŠ¤ (> ${right}): ${rightMiss}ìƒ· (${rightPct.toFixed(1)}%)\n\n`;
    detail += `â—† ê°€ì¤‘ í˜ë„í‹° ì ìˆ˜\n`;
    detail += `   - wL = ${wL.toFixed(1)}, wR = ${wR.toFixed(1)}\n`;
    detail += `   - Weighted Penalty = (ì¢Œì¸¡ ë¯¸ìŠ¤ * wL) + (ìš°ì¸¡ ë¯¸ìŠ¤ * wR)\n`;
    detail += `   - = ${leftMiss} * ${wL.toFixed(1)} + ${rightMiss} * ${wR.toFixed(1)} = ${weightedPenalty.toFixed(1)}\n\n`;
    detail += `â€» p=${p}% ì»¤ë²„ ê°œë…ì„ ì ìš©í•œ Ïƒ íƒ€ì›/ë¶„ì‚° ì‹œê°í™”ëŠ” ì¶”í›„ í™•ì¥ í¬ì¸íŠ¸ì…ë‹ˆë‹¤.\n`;

    return { summaryText, detailText: detail };
  }

  // -----------------------------
  // ë‹¨ìˆœ í†µê³„ í•¨ìˆ˜
  // -----------------------------
  function mean(arr) {
    if (!arr.length) return 0;
    return arr.reduce((a, b) => a + b, 0) / arr.length;
  }

  function stdDev(arr, m) {
    if (!arr.length) return 0;
    const varSum = arr.reduce((acc, v) => acc + Math.pow(v - m, 2), 0) / arr.length;
    return Math.sqrt(varSum);
  }

  // -----------------------------
  // Scatter Plot (Carry vs Offline)
  // -----------------------------
  function drawScatter(samples) {
    const canvas = document.getElementById('scatterCanvas');
    if (!canvas || !canvas.getContext) return;
    const ctx = canvas.getContext('2d');

    const width = canvas.width;
    const height = canvas.height;

    ctx.clearRect(0, 0, width, height);

    if (samples.length === 0) return;

    const carries = samples.map(s => s.carry);
    const offlines = samples.map(s => s.offline);

    const minCarry = Math.min(...carries);
    const maxCarry = Math.max(...carries);
    const minOffline = Math.min(...offlines);
    const maxOffline = Math.max(...offlines);

    const padding = 40;
    const plotWidth = width - padding * 2;
    const plotHeight = height - padding * 2;

    // ë°°ê²½
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg');
    ctx.fillRect(0, 0, width, height);

    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border');
    ctx.lineWidth = 1;
    ctx.strokeRect(padding, padding, plotWidth, plotHeight);

    // ì¶• ë¼ë²¨
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text');
    ctx.font = '12px sans-serif';
    ctx.fillText('Carry (' + state.unit + ')', padding, padding - 8);
    ctx.save();
    ctx.translate(10, padding + plotHeight / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText('Offline (' + state.unit + ')', 0, 0);
    ctx.restore();

    // ìŠ¤ì¼€ì¼ í•¨ìˆ˜
    const scaleX = (c) => {
      if (maxCarry === minCarry) return padding + plotWidth / 2;
      return padding + ((c - minCarry) / (maxCarry - minCarry)) * plotWidth;
    };
    const scaleY = (o) => {
      if (maxOffline === minOffline) return padding + plotHeight / 2;
      // offline: ìœ„ê°€ +, ì•„ë˜ê°€ -ê°€ ì•„ë‹ˆë¼ yì¶• ë°˜ì „
      return padding + plotHeight - ((o - minOffline) / (maxOffline - minOffline)) * plotHeight;
    };

    // ìƒ· ì  ê·¸ë¦¬ê¸°
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--primary');
    samples.forEach(s => {
      const x = scaleX(s.carry);
      const y = scaleY(s.offline);
      ctx.beginPath();
      ctx.arc(x, y, 3, 0, Math.PI * 2);
      ctx.fill();
    });

    // LNG50 ê²½ê³„ì„  í‘œì‹œ (ì„ íƒ)
    if (state.mode === 'LNG50') {
      const left = Number(document.getElementById('lngLeft').value || '-25');
      const right = Number(document.getElementById('lngRight').value || '25');

      const yLeft = scaleY(left);
      const yRight = scaleY(right);

      ctx.strokeStyle = '#ff8800';
      ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.moveTo(padding, yLeft);
      ctx.lineTo(padding + plotWidth, yLeft);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(padding, yRight);
      ctx.lineTo(padding + plotWidth, yRight);
      ctx.stroke();
      ctx.setLineDash([]);
    }
  }

</script>
</body>
</html>


