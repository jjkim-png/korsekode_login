<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>TK22 — Kodeck (라운딩 경량 기록기 • 모바일)</title>
<style>
  :root{
    --brand:#2b2363; --accent:#4b3dd1; --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a;
    --muted:#6b7280; --border:#e6e8ef; --good:#10b981; --bad:#ef4444; --warn:#f59e0b;
    --radius:16px; --shadow:0 10px 28px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--ink);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;}
  header{position:sticky; top:0; z-index:60; background:var(--brand); color:#fff; padding:14px 16px}
  header h1{margin:0; font-size:16px; letter-spacing:.2px}
  .container{max-width:720px; margin:0 auto; padding:12px 12px 120px}
  section{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); margin:12px 0; padding:12px}
  h2{font-size:15px; margin:0 0 8px}
  label{display:block; font-size:12px; color:#374151; margin:6px 0 6px}
  input,select,button{width:100%; padding:14px 14px; border-radius:14px; border:1px solid #d7d9e0; background:#fff; outline:none; font-size:16px}
  input:focus,select:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(75,61,209,.18)}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .seg{display:flex; gap:6px}
  .seg button{flex:1; padding:12px; border-radius:12px; border:1px solid var(--border); background:#fff; font-weight:700}
  .seg button.active{background:#111827; color:#fff; border-color:#111827}
  .seg.small button{padding:8px; font-size:13px}
  .pill{display:inline-flex; align-items:center; justify-content:center; height:36px; padding:0 12px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:13px; border:1px solid #dfe3ff}
  .chips{display:flex; gap:6px; flex-wrap:wrap}
  .chip{display:inline-flex; align-items:center; justify-content:center; padding:8px 10px; border-radius:10px; background:#f3f4f6; border:1px solid var(--border); font-size:14px; min-width:48px}
  .small{font-size:12px; color:var(--muted)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, monospace}
  canvas{width:100%; max-width:320px; aspect-ratio:1/1; background:#ffffff; border-radius:12px; border:1px solid var(--border); touch-action:manipulation}
  .sticky{position:fixed; bottom:0; left:0; right:0; z-index:70; background:#fff; border-top:1px solid var(--border);
    padding:10px 12px calc(10px + env(safe-area-inset-bottom)); display:flex; gap:8px; flex-wrap:wrap; box-shadow:0 -10px 28px rgba(0,0,0,.06)}
  .toast{position:fixed; bottom:84px; left:50%; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:999px; font-size:14px; opacity:0; pointer-events:none; transition:opacity .25s; z-index:80}
  .toast.show{opacity:1}
  .top-hint{position:sticky; top:48px; z-index:59; margin:0 12px; display:none}
  .top-hint .pill{background:#fff7ed; border-color:#fed7aa; color:#9a3412}
  table{width:100%; border-collapse:collapse}
  th,td{font-size:12px; border-bottom:1px solid #eee; padding:8px; text-align:center; white-space:nowrap}
  /* 강조 애니메이션 */
  @keyframes blinkRow { 0%{background:#fff8c5} 100%{background:transparent} }
  .row-blink{animation:blinkRow .8s ease-out 1}
  /* 포커스 하이라이트 */
  .focus-ring{box-shadow:0 0 0 3px rgba(245,158,11,.35) inset; border-radius:12px; transition:box-shadow .25s}
  /* 미리보기 배지 */
  .preview{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#eef2ff; border:1px solid #dfe3ff; color:#3730a3; font-weight:700; font-size:13px}
</style>
</head>
<body>
  <header><h1>TK22 — Kodeck (라운딩 경량 기록기)</h1></header>
  <div class="top-hint" id="par3Hint"><span class="pill">Par3 규칙 적용: 티샷은 APP(파온)</span></div>

  <div class="container">

    <!-- 라운드/홀 -->
    <section id="round">
      <h2>라운드 / 홀</h2>
      <div class="row">
        <div>
          <label>Hole</label>
          <div class="seg">
            <button id="btnHolePrev" class="ghost" style="max-width:80px">◀</button>
            <input id="inpHole" type="number" min="1" max="18" value="1"/>
            <button id="btnHoleNext" class="ghost" style="max-width:80px">▶</button>
          </div>
        </div>
        <div>
          <label>Par</label>
          <div class="seg" id="segPar">
            <button data-par="3">3</button>
            <button data-par="4" class="active">4</button>
            <button data-par="5">5</button>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <div>
          <label>Sequence(샷 번호)</label>
          <div class="seg">
            <div class="pill" style="flex:1;text-align:center" id="lblSeq">#1</div>
            <button id="btnResetSeq" class="ghost" style="max-width:120px">리셋</button>
          </div>
        </div>
        <div>
          <label>투온 시도 (Par5)</label>
          <div class="seg" id="segTwoOn">
            <button data-twoon="off" class="active">X</button>
            <button data-twoon="on">O</button>
          </div>
        </div>
      </div>
      <div class="small">* Par3에서 <b>티샷</b>을 누르면 자동으로 <b>APP(파온)</b>으로 전환됩니다. (상단 PILL 상시 표기)</div>
    </section>

    <!-- 페이즈 -->
    <section id="phase">
      <h2>페이즈 선택</h2>
      <div class="seg" id="segPhase">
        <button data-phase="tee" class="active">티샷</button>
        <button data-phase="approach">파온(중거리)</button>
        <button data-phase="around">30m 이내</button>
        <button data-phase="putt">퍼팅</button>
      </div>
    </section>

    <!-- 입력 -->
    <section id="form">
      <h2>입력</h2>

      <!-- 거리 -->
      <div class="row">
        <div>
          <label>현재 남은거리 (m)</label>
          <input id="inpCurM" type="number" inputmode="decimal" placeholder="예: 380 (티샷은 핀까지 총거리)"/>
        </div>
        <div>
          <label>다음 남은거리 (m)</label>
          <input id="inpNextM" type="number" inputmode="decimal" placeholder="예: 150"/>
        </div>
      </div>

      <!-- 동적 칩(phase별 자동 구성) -->
      <div class="chips" id="chips" style="margin-top:6px"></div>

      <!-- 옵션 -->
      <div class="row" style="margin-top:6px">
        <div>
          <label>클럽 (선택)</label>
          <select id="ddClub">
            <option value="">-</option>
            <option>Dr</option><option>3w</option><option>2i</option><option>3i</option><option>4i</option>
            <option>5i</option><option>6i</option><option>7i</option><option>8i</option><option>9i</option>
            <option>pw</option><option>50</option><option>52</option><option>54</option><option>56</option>
            <option>58</option><option>60</option><option>putter</option>
          </select>
        </div>
        <div>
          <label>어프로치 타입 (30m 이내)</label>
          <select id="ddApType">
            <option value="">-</option>
            <option value="basic">기본</option>
            <option value="running">러닝</option>
            <option value="flop">플롭</option>
          </select>
        </div>
      </div>

      <!-- 벌타 -->
      <div style="margin-top:8px">
        <label>벌타</label>
        <div class="row">
          <div id="penTypeWrap">
            <div class="seg small" id="segPenaltyType">
              <button data-pt="none" class="active">없음</button>
              <button data-pt="HAZ">HAZ(+1)</button>
              <button data-pt="OB">OB(+2)</button>
            </div>
          </div>
          <div id="penDirWrap">
            <div class="seg small" id="segPenaltyDir">
              <button data-pd="" class="active">-</button>
              <button data-pd="L">L</button>
              <button data-pd="R">R</button>
              <button data-pd="Long">Long</button>
              <button data-pd="Short">Short</button>
            </div>
          </div>
        </div>
        <div class="small" id="seqPreview" style="margin-top:6px;display:none">
          <span class="preview" id="seqPreviewPill">다음 샷 미리보기</span>
        </div>
      </div>

      <!-- 캔버스(조건부: APP(투온 O) / 30m 이내) -->
      <div id="canvasWrap" style="margin-top:10px; display:none">
        <div class="row">
          <div>
            <label>그린 반지름 (m) — 스케일</label>
            <input id="inpGreenR" type="number" value="15"/>
          </div>
          <div>
            <label>좌표 결과 (m, 핀 기준)</label>
            <div class="pill mono" id="lblXY">x: 0.0 / y: 0.0 (dist 0.0)</div>
          </div>
        </div>
        <div style="display:flex; align-items:center; justify-content:center; margin-top:8px">
          <canvas id="greenCanvas" width="320" height="320"></canvas>
        </div>
        <div class="small" style="margin-top:4px">
          ● 클릭/터치: 핀 기준 (x,y) 기록 — <b>그린 원=반지름 15m</b>, 외곽 연한 링=그린 주변(30m).  
          ● <b>회색 점선 링</b>은 입력한 <b>다음 남은거리</b> 반지름 가이드입니다.
        </div>
        <div style="margin-top:6px">
          <button id="btnClearDot" class="chip" style="border-radius:999px">좌표 초기화</button>
        </div>
      </div>

      <!-- 퍼팅 전용 -->
      <div id="puttWrap" style="margin-top:8px; display:none">
        <div class="seg small" id="segPuttHoled">
          <button data-holed="false" class="active">미스</button>
          <button data-holed="true">홀인</button>
        </div>
        <div class="small" style="margin-top:6px">* 퍼팅은 캔버스 비활성(속도 우선). 직전 <b>다음 남은거리</b>가 자동으로 현재거리로 이어집니다.</div>
      </div>
    </section>

    <!-- 샷 리스트 -->
    <section id="shots">
      <h2>샷 리스트</h2>
      <div style="overflow:auto">
        <table id="tblShots">
          <thead><tr>
            <th>Hole</th><th>Par</th><th>#</th><th>Phase</th><th>cur→next(m)</th>
            <th>클럽</th><th>투온</th><th>벌타</th><th>좌표</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

  </div>

  <!-- 고정 액션 -->
  <div class="sticky">
    <button class="btn brand" id="btnAddShot" style="flex:2">샷 추가</button>
    <button class="btn" id="btnEndHole" style="flex:1">홀 종료</button>
    <button class="btn ghost" id="btnUndo" style="flex:1">되돌리기</button>
    <button class="btn warn" id="btnExport" style="flex:1">내보내기(JSON)</button>
  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  // ===== Utils =====
  const $ = s=>document.querySelector(s), $$ = s=>Array.from(document.querySelectorAll(s));
  const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));
  const toast = (msg)=>{ const t=$('#toast'); t.textContent=msg; t.classList.add('show');
    clearTimeout(toast._id); toast._id=setTimeout(()=>t.classList.remove('show'), 1600); };

  // ===== State =====
  const nowId = ()=>`R-${Date.now()}-${Math.floor(Math.random()*1000)}`;
  let round = JSON.parse(localStorage.getItem('kodeck_round')||'null');
  if(!round){ round = { roundId: nowId(), date: new Date().toISOString(), parMap:{}, shots:[] }; }
  let hole=1, par=4, seq=1, phase='tee', twoOnTry=false;
  let penaltyType='none', penaltyDir='';
  let lastPoint=null;

  // ===== Elements =====
  const inpHole = $('#inpHole'), lblSeq = $('#lblSeq');
  const segPar = $('#segPar'), segPhase = $('#segPhase'), segTwoOn=$('#segTwoOn');
  const inpCurM = $('#inpCurM'), inpNextM = $('#inpNextM'), ddClub=$('#ddClub'), ddApType=$('#ddApType');
  const segPenaltyType = $('#segPenaltyType'), segPenaltyDir = $('#segPenaltyDir');
  const penDirWrap = $('#penDirWrap');
  const canvasWrap = $('#canvasWrap'), greenCanvas = $('#greenCanvas'), lblXY = $('#lblXY'), inpGreenR = $('#inpGreenR');
  const puttWrap = $('#puttWrap'), par3Hint = $('#par3Hint');
  const chipsBox = $('#chips'), seqPreview = $('#seqPreview'), seqPreviewPill = $('#seqPreviewPill');

  // ===== Local Save =====
  function saveLocal(){ localStorage.setItem('kodeck_round', JSON.stringify(round)); }

  // ===== Hole / Par =====
  function applySeq(v){ seq=v; lblSeq.textContent = '#'+seq; updatePreview(); }
  function applyPar(p){
    par = p; $$('#segPar button').forEach(b=>b.classList.toggle('active', Number(b.dataset.par)===par));
    // 투온 스위치 시각
    $('#segTwoOn').style.opacity = (par===5?1:0.5);
    if(par!==5) applyTwoOn(false);
    updatePar3Hint();
  }
  function setHole(h){
    hole = clamp(h,1,18); inpHole.value=hole; applySeq(1);
    if(round.parMap[hole]==null){ round.parMap[hole]=par; saveLocal(); }
    applyPar(round.parMap[hole]||par);
    toast(`Hole ${hole} · Par ${par}${par===5?` · 투온 ${twoOnTry?'O':'X'}`:''}`);
  }
  inpHole.addEventListener('change', ()=> setHole(Number(inpHole.value||1)));
  $('#btnHolePrev').addEventListener('click', ()=> setHole(hole-1));
  $('#btnHoleNext').addEventListener('click', ()=> setHole(hole+1));
  $('#btnResetSeq').addEventListener('click', ()=>{ applySeq(1); toast('시퀀스 리셋'); });

  segPar.addEventListener('click', (e)=>{
    const btn=e.target.closest('button'); if(!btn) return;
    const p = Number(btn.dataset.par); applyPar(p); round.parMap[hole]=par; saveLocal(); applyPhase(phase);
  });

  // ===== Phase / Two-on =====
  function updatePa
