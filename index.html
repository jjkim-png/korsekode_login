<script>
(function(){
  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
  const L = (k)=> i18n[state.lang][k] || k;

  const i18n = {
    ko:{
      player:'선수 ID', course:'코스명', holes:'홀 수', tee:'티샷', club:'클럽', teeRes:'결과',
      approach:'어프로치', distToPin:'핀까지 거리 (yd)', target:'목표', apRes:'결과',
      green:'그린 & 퍼팅', gir:'GIR', firstPutt:'첫 퍼트 거리 (ft)', putts:'퍼트 수',
      shortGame:'쇼트게임', sgLie:'라이', sgStrokes:'그린까지 타수', leave:'남은 거리 (ft)',
      penalty:'패널티 & 메모', pen:'패널티', note:'메모'
    },
    en:{
      player:'Player ID', course:'Course', holes:'Holes', tee:'Tee Shot', club:'Club', teeRes:'Result',
      approach:'Approach', distToPin:'Dist to Pin (yd)', target:'Target', apRes:'Result',
      green:'Green & Putting', gir:'GIR', firstPutt:'First Putt (ft)', putts:'Putts',
      shortGame:'Short Game', sgLie:'Lie', sgStrokes:'Strokes to Green', leave:'Leave (ft)',
      penalty:'Penalties & Notes', pen:'Penalty', note:'Notes'
    }
  };

  const clubs = ['D','3W','5W','UT','4I','5I','6I','7I','8I','9I','PW','GW','SW','LW'];
  const teeResults = [
    {k:'FW', lab:'페어웨이'},
    {k:'R',  lab:'러프'},
    {k:'B',  lab:'벙커'},
    {k:'T',  lab:'나무/정글'},
    {k:'O',  lab:'OB'},
    {k:'H',  lab:'해저드'}
  ];
  const targets = [
    {k:'safeL',lab:'세이프 L'},
    {k:'pin',  lab:'핀'},
    {k:'safeR',lab:'세이프 R'}
  ];
  const apResults = [
    {k:'G', lab:'온그린'},
    {k:'L', lab:'좌 미스'},
    {k:'R', lab:'우 미스'},
    {k:'S', lab:'짧음'},
    {k:'LNG',lab:'긺'},
  ];
  const sgLies = [
    {k:'FW',lab:'페어웨이'},
    {k:'RF',lab:'러프'},
    {k:'BK',lab:'벙커'},
  ];
  const pens = [
    {k:'OB',lab:'OB +1'},
    {k:'HZ',lab:'해저드 +1'},
    {k:'UP',lab:'언플 +1'}
  ];

  let state = {
    lang:'ko',
    hole:1,
    holeCount:18,
    stack:[], // for last-field removal
  };

  // Initialize dynamic buttons
  function makeButtons(list, mountSel, bindKey){
    const host = typeof mountSel==='string'? $(mountSel): mountSel;
    host.innerHTML = '';
    list.forEach(item=>{
      const b=document.createElement('button');
      b.className='btn';
      b.textContent=item.lab||item;
      b.dataset.val=item.k||item;
      if(bindKey) b.dataset.bind=bindKey;
      b.addEventListener('click',()=>toggleBtn(b, bindKey));
      host.appendChild(b);
    });
  }
  makeButtons(clubs, '#clubBtns', 'club');
  makeButtons(teeResults, '#teeResBtns', 'tee');
  makeButtons(targets, '#targetBtns', 'target');
  makeButtons(apResults, '#apResBtns', 'ap');
  makeButtons(sgLies, '#sgLieBtns', 'sgLie');
  makeButtons(pens, '#penBtns', 'pen');

  function toggleBtn(btn, key){
    // single-select per group except penalties (multi)
    const multi = key==='pen';
    const group = $$(`[data-bind="${key}"]`);
    if(!multi){ group.forEach(x=>x.removeAttribute('aria-pressed')); }
    const pressed = btn.getAttribute('aria-pressed')==='true';
    btn.setAttribute('aria-pressed', (!pressed).toString());
    if(!multi){
      setField(key, (!pressed)? btn.dataset.val: null);
    } else {
      // toggle presence in penalties
      const cur = getHole().penalties || [];
      const val = btn.dataset.val;
      const i = cur.indexOf(val);
      if(i>-1){ cur.splice(i,1);} else {cur.push(val);}
      setField('penalties', cur);
    }
    refreshStatus();
  }

  // Storage helpers
  const KEY = 'kodeck_round_v1';
  function load(){
    const raw=localStorage.getItem(KEY);
    return raw? JSON.parse(raw): {
      meta:{ playerId:'', course:'', date:new Date().toISOString().slice(0,10), holeCount:18 },
      holes:{} // id -> partials
    };
  }
  function save(obj){ localStorage.setItem(KEY, JSON.stringify(obj)); }
  function getRound(){ return load(); }
  function getHole(n=state.hole){ const r=getRound(); return r.holes[n]||(r.holes[n]={}); }
  function setHole(n, data){ const r=getRound(); r.holes[n]=Object.assign({}, r.holes[n]||{}, data); save(r); }
  function setField(key, val){ const h=getHole(); if(val===null){ delete h[key]; } else { h[key]=val; } setHole(state.hole,h); }

  // UI bindings
  function syncMeta(){
    const r=getRound();
    $('#playerId').value=r.meta.playerId||'';
    $('#courseName').value=r.meta.course||'';
    $('#holeCount').value=r.meta.holeCount||state.holeCount;
    state.holeCount = parseInt($('#holeCount').value||'18',10);
    // progress bar col count 반영
    $('#progressBar').style.gridTemplateColumns = `repeat(${state.holeCount},1fr)`;
  }
  function writeMeta(){
    const r=getRound();
    r.meta.playerId=$('#playerId').value.trim();
    r.meta.course=$('#courseName').value.trim();
    r.meta.date=r.meta.date||new Date().toISOString().slice(0,10);
    r.meta.holeCount=parseInt($('#holeCount').value||'18',10); // ✅ 저장
    save(r);
  }

  function go(n){
    writeMeta();
    const max = parseInt($('#holeCount').value||'18',10);
    state.holeCount = Math.max(3, Math.min(27, max));
    state.hole = Math.max(1, Math.min(state.holeCount, n));
    $('#holeNum').value = state.hole;
    $('#holeLabel').textContent = `HOLE ${state.hole}`;
    renderHole();
    renderDots();
  }

  function isHoleComplete(h){
    const teeOk = !!(h.club && h.tee);
    const apOk  = !!(h.ap || h.target || h.dist!=null);
    const puttOk= (h.gir==='Y' && h.putts!=null) || (h.gir==='N' && h.sgLie && h.sgStrokes!=null && h.putts!=null);
    return teeOk && apOk && puttOk;
  }

  function renderDots(){
    const host = $('#progressBar');
    host.innerHTML='';
    const r = getRound();
    for(let i=1;i<=state.holeCount;i++){
      const d = r.holes[i]||{};
      const el=document.createElement('div');
      el.className='dot';
      if(Object.keys(d).length){
        el.classList.add(isHoleComplete(d) ? 'ok' : (d.penalties?.length ? 'bad' : 'warn'));
      }
      host.appendChild(el);
    }
  }

  function renderHole(){
    // clear actives
    $$('[aria-pressed]').forEach(x=>x.removeAttribute('aria-pressed'));
    const h = getHole();
    // set actives from state
    ['club','tee','target','ap','gir','putts','sgStrokes','sgLie'].forEach(k=>{
      if(h[k]!=null){ const b = $(`[data-bind="${k}"][data-val="${h[k]}"]`); if(b) b.setAttribute('aria-pressed','true'); }
    });
    if(h.penalties){ h.penalties.forEach(p=>{ const b=$(`[data-bind="pen"][data-val="${p}"]`); if(b) b && b.setAttribute('aria-pressed','true');}); }
    $('#dist').value = h.dist||'';
    $('#firstPutt').value = h.firstPutt||'';
    $('#leaveFt').value = h.leaveFt||'';
    $('#notes').value = h.notes||'';
    $('#sgCard').style.display = h.gir==='N'? 'block':'none';
    refreshStatus();
  }

  function refreshStatus(){
    const h = getHole();
    const parts = [];
    if(h.club) parts.push(`Tee:${h.club}`);
    if(h.tee) parts.push(h.tee);
    if(h.ap) parts.push(h.ap);
    if(h.gir) parts.push(`GIR:${h.gir}`);
    if(h.putts!=null) parts.push(`${h.putts}P`);
    if(h.penalties&&h.penalties.length) parts.push('PEN');
    $('#holeStatus').textContent = parts.join(' · ') || '—';
  }

  // inputs
  $('#dist').addEventListener('change', e=>setField('dist', num(e.target.value)));
  $('#firstPutt').addEventListener('change', e=>setField('firstPutt', num(e.target.value)));
  $('#leaveFt').addEventListener('change', e=>setField('leaveFt', num(e.target.value)));
  $('#notes').addEventListener('change', e=>setField('notes', e.target.value));

  // Enter 이동 & 전체 선택
  ['#dist','#firstPutt','#leaveFt'].forEach(sel=>{
    const el=$(sel);
    el.addEventListener('focus', ()=>{ el.select(); });
    el.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        e.preventDefault();
        if(sel==='#dist') $('#firstPutt').focus();
        else if(sel==='#firstPutt') $('#leaveFt').focus();
        else $('#saveBtn').click();
      }
    });
  });

  $('#holeNum').addEventListener('change', e=>go(parseInt(e.target.value||'1',10)));
  $('#prevHole').addEventListener('click', ()=>go(state.hole-1));
  $('#nextHole').addEventListener('click', ()=>go(state.hole+1));
  $('#holeCount').addEventListener('change', ()=>{
    const v=parseInt($('#holeCount').value||'18',10);
    state.holeCount=Math.max(3,Math.min(27,v));
    $('#progressBar').style.gridTemplateColumns = `repeat(${state.holeCount},1fr)`;
    renderDots(); go(state.hole);
  });

  // bind generic buttons by delegation
  document.body.addEventListener('click', (e)=>{
    const t=e.target.closest('[data-bind]');
    if(!t) return;
    const key=t.dataset.bind;
    const val=t.dataset.val;

    if(key==='ap'){
      setField('ap', val);
      if(val!=='G'){ setField('gir','N'); $('#sgCard').style.display='block'; }
      refreshStatus(); return;
    }
    if(key==='gir'){
      setField('gir', val);
      $('#sgCard').style.display = val==='N'? 'block':'none';
    } else if(key==='putts'){
      setField('putts', parseInt(val,10));
    } else if(key==='sgStrokes'){
      setField('sgStrokes', parseInt(val,10));
    } else if(key==='club' || key==='tee' || key==='target' || key==='sgLie'){
      setField(key, val);
    }
    refreshStatus();
  });

  // actions
  $('#undoBtn').addEventListener('click', ()=>{
    const r=getRound();
    const h=r.holes[state.hole]||{};
    state.stack.push(JSON.stringify(h));
    // heuristic last-field removal
    const order=['notes','penalties','putts','firstPutt','leaveFt','sgStrokes','sgLie','gir','ap','target','dist','tee','club'];
    for(const k of order){ if(h[k]!=null){ delete h[k]; break; } }
    setHole(state.hole,h); renderHole();
  });
  $('#clearBtn').addEventListener('click', ()=>{ setHole(state.hole, {}); renderHole(); });

  // === Quick Summary flow ===
  $('#saveBtn').addEventListener('click', ()=>{
    writeMeta();
    const r=getRound();
    if(!r.meta.playerId){ alert('선수 ID를 입력해 주세요.'); $('#playerId').focus(); return; }
    // 요약 표시(현재 홀)
    showSummary(state.hole);
  });

  // import / export
  $('#exportBtn').addEventListener('click', ()=>{
    writeMeta();
    const r = getRound();
    if(!r.meta.playerId){ alert('선수 ID가 없습니다.'); $('#playerId').focus(); return; }
    if(Object.keys(r.holes).length===0){ alert('기록된 홀이 없습니다.'); return; }
    const payload = toBridgeJSON(r);
    const csv = toCSV(payload);
    const blobJson = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const blobCsv = new Blob([csv], {type:'text/csv'});
    download(blobJson, `kodeck_${r.meta.playerId||'player'}_${r.meta.date}.json`);
    setTimeout(()=>download(blobCsv, `kodeck_${r.meta.playerId||'player'}_${r.meta.date}.csv`), 250);
  });
  $('#importBtn').addEventListener('click', ()=>{
    const inp=document.createElement('input');
    inp.type='file'; inp.accept='.json';
    inp.onchange=(e)=>{
      const f=e.target.files[0];
      const rd=new FileReader();
      rd.onload=()=>{
        try{ const data=JSON.parse(rd.result); fromBridgeJSON(data); renderDots(); renderHole(); }
        catch(err){ alert('JSON 파싱 오류'); }
      };
      rd.readAsText(f);
    };
    inp.click();
  });

  // 새 라운드
  $('#newRoundBtn').addEventListener('click', ()=>{
    const today = new Date().toISOString().slice(0,10);
    const holeCount = parseInt($('#holeCount').value||'18',10);
    save({ meta:{ playerId:'', course:'', date:today, holeCount }, holes:{} });
    state.hole=1; state.holeCount=holeCount;
    syncMeta(); renderDots(); renderHole();
    $('#playerId').focus();
  });

  // language toggle
  $('#langToggle').addEventListener('change', (e)=>{
    state.lang = e.target.checked? 'en':'ko';
    $$('[data-t]').forEach(el=>{ const k=el.getAttribute('data-t'); el.textContent=L(k); });
  });

  // helpers
  function num(v){ const n=parseInt(v,10); return isFinite(n)? n: '' }
  function download(blob, filename){
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download=filename; a.click();
    URL.revokeObjectURL(a.href);
  }

  // === Summary Modal helpers ===
  function showSummary(holeNo){
    const r=getRound();
    const h=r.holes[holeNo]||{};
    // 진행도 표시를 위해 즉시 반영
    renderDots();

    // 제목/메타
    $('#summaryTitle').textContent = `Hole ${holeNo} Summary`;
    $('#summaryMeta').textContent = `${r.meta.playerId||''} · ${r.meta.course||''} · ${r.meta.date||''}`;

    // 사람이 읽는 요약
    const rows = [
      ['Tee', `${h.club||'-'} / ${h.tee||'-'}`],
      ['Approach', `${(h.dist??'-')}yd / ${h.target||'-'} / ${h.ap||'-'}`],
      ['GIR', h.gir||'-'],
      ['Short Game', h.gir==='N' ? `${h.sgLie||'-'} / ${h.sgStrokes??'-'} / leave ${h.leaveFt??'-'}ft` : '—'],
      ['Putts', (h.putts!=null? h.putts : '-')],
      ['Penalties', (h.penalties&&h.penalties.length? h.penalties.join('|') : '-')],
      ['Notes', (h.notes||'-')]
    ];
    const grid = $('#summaryGrid');
    grid.innerHTML='';
    rows.forEach(([k,v])=>{
      const kEl=document.createElement('div'); kEl.className='k'; kEl.textContent=k;
      const vEl=document.createElement('div'); vEl.className='v'; vEl.textContent=v;
      grid.appendChild(kEl); grid.appendChild(vEl);
    });

    // 해당 홀 CSV 라인
    const payload = toBridgeJSON(r);
    const line = csvHeader() + '\n' + holeToCSVLine(payload, holeNo);
    $('#summaryCSV').textContent = line;

    // 모달 표시
    $('#summaryModal').classList.add('show');
    $('#summaryModal').setAttribute('aria-hidden','false');
  }

  $('#closeSummary').addEventListener('click', closeSummary);
  $('#editHoleBtn').addEventListener('click', ()=>{
    closeSummary();
    // 그대로 현재 홀에서 편집 계속
  });
  $('#confirmNextHole').addEventListener('click', ()=>{
    closeSummary();
    go(state.hole+1);
  });
  $('#copyCSV').addEventListener('click', ()=>{
    const txt = $('#summaryCSV').textContent;
    navigator.clipboard.writeText(txt).then(()=>{ alert('CSV 복사 완료'); });
  });

  function closeSummary(){
    $('#summaryModal').classList.remove('show');
    $('#summaryModal').setAttribute('aria-hidden','true');
  }

  // Export schema (BRIDGE → compatible, minimal fields for later full SG in Korsekode)
  function toBridgeJSON(r){
    const holes=[];
    const total = r.meta.holeCount || state.holeCount;
    for(let i=1;i<= total; i++){
      const h=r.holes[i]||{};
      holes.push({
        hole:i,
        par:null,             // optional later fill
        tee:{ club:h.club||null, result:h.tee||null },
        approach:{ dist_yd: h.dist||null, target:h.target||null, result:h.ap||null },
        green:{ gir: h.gir||null, first_putt_ft: h.firstPutt||null, putts: (h.putts!=null? h.putts: null) },
        short_game: h.gir==='N'? { lie:h.sgLie||null, strokes_to_green:h.sgStrokes||null, leave_ft:h.leaveFt||null } : null,
        penalties: h.penalties||[],
        notes: h.notes||''
      });
    }
    return {
      meta:{ player_id:r.meta.playerId, course:r.meta.course, date:r.meta.date, holes: r.meta.holeCount||state.holeCount },
      holes
    };
  }

  function csvHeader(){
    return ['player_id','course','date','hole','tee_club','tee_res','ap_dist_yd','ap_target','ap_res','gir','sg_lie','sg_strokes','sg_leave_ft','first_putt_ft','putts','penalties','notes'].join(',');
  }

  function csvEsc(x){
    if(x==null) return '';
    const s= String(x);
    if(/[",\n]/.test(s)){ return `"${s.replaceAll('"','""')}"`; }
    return s;
  }

  function holeToCSVLine(payload, holeNo){
    const h = payload.holes.find(x=>x.hole===holeNo) || {};
    return [
      csvEsc(payload.meta.player_id),
      csvEsc(payload.meta.course),
      csvEsc(payload.meta.date),
      csvEsc(holeNo),
      csvEsc(h.tee?.club),
      csvEsc(h.tee?.result),
      csvEsc(h.approach?.dist_yd),
      csvEsc(h.approach?.target),
      csvEsc(h.approach?.result),
      csvEsc(h.green?.gir),
      csvEsc(h.short_game?.lie),
      csvEsc(h.short_game?.strokes_to_green),
      csvEsc(h.short_game?.leave_ft),
      csvEsc(h.green?.first_putt_ft),
      csvEsc(h.green?.putts),
      csvEsc((h.penalties||[]).join('|')),
      csvEsc(h.notes||'')
    ].join(',');
  }

  function toCSV(payload){
    const H = csvHeader();
    const L=[]; L.push(H);
    payload.holes.forEach(h=>{
      L.push([
        csvEsc(payload.meta.player_id),
        csvEsc(payload.meta.course),
        csvEsc(payload.meta.date),
        csvEsc(h.hole),
        csvEsc(h.tee?.club),
        csvEsc(h.tee?.result),
        csvEsc(h.approach?.dist_yd),
        csvEsc(h.approach?.target),
        csvEsc(h.approach?.result),
        csvEsc(h.green?.gir),
        csvEsc(h.short_game?.lie),
        csvEsc(h.short_game?.strokes_to_green),
        csvEsc(h.short_game?.leave_ft),
        csvEsc(h.green?.first_putt_ft),
        csvEsc(h.green?.putts),
        csvEsc((h.penalties||[]).join('|')),
        csvEsc(h.notes||'')
      ].join(','));
    });
    return L.join('\n');
  }

  function fromBridgeJSON(payload){
    const r = {meta:{ playerId: payload.meta.player_id||'', course: payload.meta.course||'', date: payload.meta.date||new Date().toISOString().slice(0,10), holeCount: payload.meta.holes||18 }, holes:{} };
    payload.holes.forEach(h=>{
      r.holes[h.hole] = {
        club: h.tee?.club||null,
        tee: h.tee?.result||null,
        dist: h.approach?.dist_yd||null,
        target: h.approach?.target||null,
        ap: h.approach?.result||null,
        gir: h.green?.gir||null,
        firstPutt: h.green?.first_putt_ft||null,
        putts: h.green?.putts?? null,
        sgLie: h.short_game?.lie||null,
        sgStrokes: h.short_game?.strokes_to_green||null,
        leaveFt: h.short_game?.leave_ft||null,
        penalties: h.penalties||[],
        notes: h.notes||''
      };
    });
    save(r);
    state.holeCount = r.meta.holeCount||18;
    $('#holeCount').value = state.holeCount;
    $('#progressBar').style.gridTemplateColumns = `repeat(${state.holeCount},1fr)`;
  }

  // kick
  syncMeta();
  renderDots();
  renderHole();
})();
</script>
</body>
</html>
